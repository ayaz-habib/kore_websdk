!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.SpeechToTextPluginSDK=t():e.SpeechToTextPluginSDK=t()}(self,(function(){return(()=>{"use strict";var e={d:(t,o)=>{for(var n in o)e.o(o,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:o[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{SpeechToTextPlugin:()=>n});var o=function(){return o=Object.assign||function(e){for(var t,o=1,n=arguments.length;o<n;o++)for(var i in t=arguments[o])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},o.apply(this,arguments)};const n=function(){function e(e){this.name="SpeechToTextPlugin",this.config={isSpeechEnabled:!0,allowGoogleSpeech:!0},this.ttsAudioSource=null,this.recognition=null,this.isRecordingStarted=!1,this.final_transcript="",this.recognizing=!1,this.prevStr="",this.navigator=window.navigator,this.isListening=!1,this._permission=!1,this.two_line=/\n\n/g,this.one_line=/\n/g,this.speechPrefixURL="",e=e||{},this.config=o(o({},this.config),e)}return e.prototype.onHostCreate=function(){var e=this,t=e.hostInstance;this.speechPrefixURL=e.hostInstance.config.botOptions.koreSpeechAPIUrl,this.userIdentity=e.hostInstance.config.botOptions.userIdentity,this.bearerToken=e.hostInstance.config.botOptions.bearer,t.on("viewInit",(function(t){e.onInit()}))},e.prototype.onInit=function(){this.installSpeechToTextTemplate()},e.prototype.appendPickerHTMLtoChatWindowFooter=function(e){this.hostInstance.chatEle.find(".kore-chat-footer .footerContainer").append(e)},e.prototype.installSpeechToTextTemplate=function(){var e=this,t=e.hostInstance.$;e.pickerHTML=t(e.getSpeechToTextTemplateString()),e.appendPickerHTMLtoChatWindowFooter(e.pickerHTML),e.bindEvents()},e.prototype.getSpeechToTextTemplateString=function(){return'<div class="sdkFooterIcon microphoneBtn">         <button class="notRecordingMicrophone" title="Microphone On">             <i class="microphone"></i>         </button>         <button class="recordingMicrophone" title="Microphone Off" >             <i class="microphone"></i>             <span class="recordingGif"></span>         </button>         <div id="textFromServer"></div>     </div>'},e.prototype.bindEvents=function(){var e=this,t=e.hostInstance.$;t(e.pickerHTML).off("click",".notRecordingMicrophone").on("click",".notRecordingMicrophone",(function(t){e.ttsAudioSource&&e.ttsAudioSource.stop(),e.config.isSpeechEnabled&&e.getSIDToken()})),t(e.pickerHTML).off("click",".recordingMicrophone").on("click",".recordingMicrophone",(function(t){stop(),setTimeout((function(){e.setCaretEnd(document.getElementsByClassName("chatInputBox"))}),350)}))},e.prototype.getSIDToken=function(){var e=this,t=e.hostInstance.$;if(this.userIdentity=e.hostInstance.config.botOptions.userIdentity,this.bearerToken=e.hostInstance.config.botOptions.bearer,e.getSpeechToText(),e.config.allowGoogleSpeech)this.recognition?e.startGoogleWebKitRecognization():e.micEnable();else{if(!this.speechPrefixURL)return console.warn("Please provide speech socket url"),!1;t.ajax({url:this.speechPrefixURL+"asr/wss/start?email="+this.userIdentity,type:"post",headers:{Authorization:this.bearerToken?this.bearerToken:this.assertionToken},dataType:"json",success:function(t){this.sidToken=t.link,e.micEnable()},error:function(e){console.log(e)}})}},e.prototype.getSpeechToText=function(){var e=this,t=e.hostInstance.$;"webkitSpeechRecognition"in window&&e.isChrome()&&(this.recognition=new window.webkitSpeechRecognition,this.final_transcript="",this.recognition.continuous=!0,this.recognition.interimResults=!0,this.recognition.onstart=function(){this.prevStr="",this.recognizing=!0,t(".recordingMicrophone").css("display","block"),t(".notRecordingMicrophone").css("display","none")},this.recognition.onerror=function(e){console.log(e.error),t(".recordingMicrophone").trigger("click"),t(".recordingMicrophone").css("display","none"),t(".notRecordingMicrophone").css("display","block")},this.recognition.onend=function(){this.recognizing=!1,t(".recordingMicrophone").trigger("click"),t(".recordingMicrophone").css("display","none"),t(".notRecordingMicrophone").css("display","block")},this.recognition.onresult=function(o){this.final_transcript="";for(var n="",i=o.resultIndex;i<o.results.length;++i)o.results[i].isFinal?this.final_transcript+=o.results[i][0].transcript:n+=o.results[i][0].transcript;this.final_transcript=e.capitalize(this.final_transcript),this.final_transcript=e.linebreak(this.final_transcript),n=e.linebreak(n),""!==this.final_transcript&&(this.prevStr+=this.final_transcript),this.recognizing&&(t(".chatInputBox").html(this.prevStr+""+n),t(".sendButton").removeClass("disabled")),setTimeout((function(){e.setCaretEnd(document.getElementsByClassName("chatInputBox")),document.getElementsByClassName("chatInputBox")[0].scrollTop=document.getElementsByClassName("chatInputBox")[0].scrollHeight}),350)})},e.prototype.startGoogleWebKitRecognization=function(){this.recognizing?this.recognition.stop():(this.final_transcript="",this.recognition.lang="en-US",this.recognition.start())},e.prototype.micEnable=function(){var e=this;this.isRecordingStarted||(navigator.getUserMedia||(navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia),navigator.getUserMedia?(this.isRecordingStarted=!0,navigator.getUserMedia({audio:!0},e.success,(function(t){e.isRecordingStarted=!1,alert("Please enable the microphone permission for this page")}))):(this.isRecordingStarted=!1,alert("getUserMedia is not supported in this browser.")))},e.prototype.setCaretEnd=function(e){if(e&&e.item(0)&&e.item(0).innerText.length){var t=document.createRange();t.selectNodeContents(e[0]),t.collapse(!1);var o=window.getSelection();o.removeAllRanges(),o.addRange(t),this.prevRange=t}else this.prevRange=!1,e&&e[0]&&e[0].focus()},e.prototype.isChrome=function(){var e=window.chrome,t=window.navigator,o=t.vendor,n=t.userAgent.indexOf("OPR")>-1,i=t.userAgent.indexOf("Edge")>-1;return!!t.userAgent.match("CriOS")||null!=e&&"Google Inc."===o&&!1===n&&!1===i},e.prototype.success=function(e){if(this.isListening=!0,this.mediaStream=e,!this.context){var t=window.AudioContext||window.webkitAudioContext;this.context=new t}this.mediaStreamSource=this.context.createMediaStreamSource(this.mediaStream),window.userSpeechAnalyser=this.context.createAnalyser(),this.mediaStreamSource.connect(window.userSpeechAnalyser),console.log("Mediastream created"),this._connection&&(this._connection.close(),this._connection=null),this.rec&&(this.rec.stop(),this.rec.clear(),this.rec=null),this.rec=new Recorder(this.mediaStreamSource,{workerPath:recorderWorkerPath}),console.log("Recorder Initialized"),this._permission=!0,this.config.allowGoogleSpeech?this.startGoogleSpeech():this.afterMicEnable();var o=this;setTimeout((function(){o.setCaretEnd(document.getElementsByClassName("chatInputBox"))}),600)},e.prototype.startGoogleSpeech=function(){var e=this;this.rec&&(this.rec.record(),$(".recordingMicrophone").css("display","block"),$(".notRecordingMicrophone").css("display","none"),console.log("recording..."),e.intervalKey=setInterval((function(){e.rec.export16kMono((function(t){console.log(new Date),e.config.allowGoogleSpeech?sendBlobToSpeech(t,"LINEAR16",16e3):e.socketSend(t),e.rec.clear()}),"audio/x-raw")}),1e3))},e.prototype.afterMicEnable=function(){if(navigator.getUserMedia){if(!this.rec)return this.isRecordingStarted=!1,void console.error("Recorder undefined");this._connection&&this.cancel();try{this._connection=this.createSocket()}catch(e){this.isRecordingStarted=!1,console.log(e),console.error("Web socket not supported in the browser")}}},e.prototype.cancel=function(){var e=this.hostInstance.$;(this.isRecordingStarted=!1,e(".recordingMicrophone")&&e(".recordingMicrophone").css("display","none"),e(".notRecordingMicrophone")&&e(".notRecordingMicrophone").css("display","block"),null!==this.mediaStream&&this.mediaStream&&this.mediaStream.getTracks()[0].enabled)&&this.mediaStream.getTracks()[0].stop();this._connection&&(this._connection.close(),this._connection=null),this.rec&&(this.rec.stop(),this.rec.clear()),this.sidToken=""},e.prototype.socketSend=function(e){if(this._connection){var t=this._connection.readyState;1===t?e instanceof Blob?e.size>0&&this._connection.send(e):(console.log(e),this._connection.send(e)):(this.isRecordingStarted=!1,console.error("Web Socket readyState != 1: ",t,"failed to send :"+e.type+", "+e.size),this.cancel())}else this.isRecordingStarted=!1,console.error("No web socket connection: failed to send: ",e)},e.prototype.linebreak=function(e){return e.replace(this.two_line,"<p></p>").replace(this.one_line,"<br>")},e.prototype.capitalize=function(e){return e.replace(e.substr(0,1),(function(e){return e.toUpperCase()}))},e.prototype.createSocket=function(){window.ENABLE_MICROPHONE=!0,window.SPEECH_SERVER_SOCKET_URL=this.sidToken;var e=window.SPEECH_SERVER_SOCKET_URL,t=this.userIdentity;window.WebSocket=window.WebSocket||window.MozWebSocket;var o=e+"&"+CONTENT_TYPE+"&email="+t,n=new WebSocket(o),i=this;return n.onopen=function(e){var t=i.hostInstance.$;console.log("User connected"),_user_connection=!0,i.rec.record(),t(".recordingMicrophone").css("display","block"),t(".notRecordingMicrophone").css("display","none"),console.log("recording..."),i.prevStr="",i.intervalKey=setInterval((function(){i.rec.export16kMono((function(e){i.socketSend(e),i.rec.clear()}),"audio/x-raw")}),INTERVAL)},n.onmessage=function(e){var t=i.hostInstance.$,o=e.data,n="";if(o instanceof Object&&!(o instanceof Blob))console.log("Got object that is not a blob");else if(o instanceof Blob)console.log("Got Blob");else{var r=JSON.parse(o);i.isListening&&0===r.status?(n=r.result.hypotheses[0].transcript,r.result.final&&(i.prevStr+=r.result.hypotheses[0].transcript+" ",n=""),console.log("Interm: ",n),console.log("final: ",i.prevStr),t(".chatInputBox").html(i.prevStr+""+n),setTimeout((function(){i.setCaretEnd(document.getElementsByClassName("chatInputBox")),document.getElementsByClassName("chatInputBox")[0].scrollTop=document.getElementsByClassName("chatInputBox")[0].scrollHeight}),350)):console.log("Server error : ",r.status)}},n.onclose=function(e){var t=i.hostInstance.$;""!==t(".chatInputBox").text()&&i.hostInstance.config.autoEnableSpeechAndTTS&&window.chatContainerConfig.sendMessage(t(".chatInputBox"));i.isRecordingStarted=!1,console.log("Server is closed"),console.log(e),i.cancel()},n.onerror=function(e){console.log("Error : ",e)},n},e.prototype.stop=function(){var e=this,t=e.hostInstance.$;""!==t(".chatInputBox").text()&&e.hostInstance.config.autoEnableSpeechAndTTS&&window.chatContainerConfig.sendMessage(t(".chatInputBox"));t(".recordingMicrophone").css("display","none"),t(".notRecordingMicrophone").css("display","block"),this.rec?(this.rec.stop(),this.isListening=!1,console.log("stopped recording.."),setTimeout((function(){e._connection&&(e._connection.close(),e._connection=null)}),1e3),this.rec.export16kMono((function(t){e.socketSend(t),e.rec.clear(),e._connection&&e._connection.close(),e.mediaStream.getTracks()[0].stop(),e.rec.destroy(),e.isRecordingStarted=!1}),"audio/x-raw")):console.error("Recorder undefined"),this.recognizing&&(this.recognition.stop(),this.recognizing=!1)},e}();return t})()}));